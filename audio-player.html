<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ —É—Ä–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .audio-player {
            width: 100%;
            margin: 20px 0;
        }
        .transcript {
            line-height: 1.6;
            font-size: 18px;
            margin-top: 20px;
        }
        .word {
            transition: all 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .active {
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="lesson-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <audio id="audioPlayer" class="audio-player" controls>
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã.
    </audio>
    
    <div class="controls">
        <button onclick="playPause()">‚èØÔ∏è –ü–∞—É–∑–∞/–°—Ç–∞—Ä—Ç</button>
        <button onclick="restart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
    </div>
    
    <div id="transcript" class="transcript"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        
        let currentLesson = null;
        let words = [];
        
        // –ü–æ–ª—É—á–∞–µ–º ID —É—Ä–æ–∫–∞ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('lesson');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞
        async function loadLesson() {
            try {
                const response = await fetch(`https://yourdomain.com/api/lessons/${lessonId}`);
                currentLesson = await response.json();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É–¥–∏–æ –ø–ª–µ–µ—Ä
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = currentLesson.audio_url;
                
                // –ü–∞—Ä—Å–∏–º —Å–ª–æ–≤–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
                words = parseWordsFromWhisperResult(currentLesson.whisper_data);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
                renderTranscript();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                audioPlayer.addEventListener('timeupdate', highlightCurrentWord);
                
                document.getElementById('lesson-title').textContent = currentLesson.title;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞:', error);
            }
        }
        
        function parseWordsFromWhisperResult(whisperData) {
            const words = [];
            whisperData.segments.forEach(segment => {
                segment.words.forEach(word => {
                    words.push({
                        text: word.word,
                        start: word.start,
                        end: word.end
                    });
                });
            });
            return words;
        }
        
        function renderTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            transcriptDiv.innerHTML = '';
            
            words.forEach((word, index) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'word';
                wordSpan.textContent = word.text + ' ';
                wordSpan.dataset.index = index;
                transcriptDiv.appendChild(wordSpan);
            });
        }
        
        function highlightCurrentWord() {
            const currentTime = document.getElementById('audioPlayer').currentTime;
            
            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —Å–ª–æ–≤
            document.querySelectorAll('.word').forEach(word => {
                word.classList.remove('active');
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ
            const currentWordIndex = words.findIndex(word => 
                currentTime >= word.start && currentTime < word.end
            );
            
            if (currentWordIndex !== -1) {
                const currentWordElement = document.querySelector(`.word[data-index="${currentWordIndex}"]`);
                if (currentWordElement) {
                    currentWordElement.classList.add('active');
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É —Å–ª–æ–≤—É
                    currentWordElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }
        
        function playPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        }
        
        function restart() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.onClick(() => {
            tg.close();
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ä–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadLesson();
    </script>
</body>
</html>
