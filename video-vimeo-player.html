<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ –£—Ä–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://player.vimeo.com/api/player.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            max-width: 100%;
            overflow-x: hidden;
            margin: 0;
        }
        .video-container {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            position: relative;
            margin: 15px 0;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        #vimeoPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            border: none;
        }
        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: #333;
            flex-direction: column;
            gap: 10px;
        }
        .transcript-container {
            margin-top: 20px;
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
        }
        .transcript {
            line-height: 1.8;
            font-size: 18px;
        }
        .word {
            transition: all 0.2s ease;
            padding: 4px 6px;
            margin: 2px;
            border-radius: 6px;
            display: inline-block;
            cursor: pointer;
        }
        .word.active {
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: 600;
            transform: scale(1.05);
        }
        .word:hover {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        .controls {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
            font-size: 14px;
            transition: opacity 0.2s;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:active:not(:disabled) {
            opacity: 0.8;
        }
        .lesson-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        .error-message {
            text-align: center;
            padding: 20px;
            background: #ffebee;
            border-radius: 8px;
            margin: 10px 0;
            color: #c62828;
        }
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
        }
        .status-indicator {
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="lesson-title" id="lessonTitle">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞...</div>
    
    <div class="video-container">
        <div class="video-placeholder" id="videoPlaceholder">
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
            <div class="status-indicator" id="statusIndicator">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–ª–µ–µ—Ä–∞</div>
        </div>
        <iframe 
            id="vimeoPlayer" 
            src="" 
            frameborder="0" 
            allow="autoplay; fullscreen; picture-in-picture" 
            allowfullscreen
            style="display: none;">
        </iframe>
    </div>
    
    <div class="controls">
        <button onclick="playPause()" id="playPauseBtn" disabled>‚èØÔ∏è –ü–∞—É–∑–∞/–°—Ç–∞—Ä—Ç</button>
        <button onclick="restart()" id="restartBtn" disabled>üîÑ –ó–∞–Ω–æ–≤–æ</button>
        <button onclick="skipBack()" id="skipBackBtn" disabled>‚è™ –ù–∞ 5—Å –Ω–∞–∑–∞–¥</button>
        <button onclick="skipForward()" id="skipForwardBtn" disabled>‚è© –ù–∞ 5—Å –≤–ø–µ—Ä–µ–¥</button>
        <button onclick="toggleMute()" id="muteBtn" disabled>üîä –í–∫–ª/–í—ã–∫–ª –∑–≤—É–∫</button>
        <button onclick="changeSpeed(0.75)" id="slowBtn" disabled>üê¢ –ú–µ–¥–ª–µ–Ω–Ω–æ</button>
        <button onclick="changeSpeed(1.0)" id="normalBtn" disabled>‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
        <button onclick="changeSpeed(1.5)" id="fastBtn" disabled>üöÄ –ë—ã—Å—Ç—Ä–æ</button>
    </div>
    
    <div id="errorContainer" style="display: none;"></div>
    
    <div class="transcript-container" id="transcriptContainer">
        <div id="transcript" class="transcript"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        
        let currentLesson = null;
        let words = [];
        let vimeoPlayer = null;
        let trackingInterval = null;
        let isPlayerReady = false;
        let isVideoLoaded = false;

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function loadLessonData() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            
            if (encodedData) {
                try {
                    const decodedData = atob(encodedData);
                    currentLesson = JSON.parse(decodedData);
                    console.log('Lesson data loaded:', currentLesson);
                    initializePlayer();
                } catch (error) {
                    console.error('Error parsing lesson data:', error);
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞: ' + error.message);
                }
            } else {
                showError('–î–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã');
            }
        }
        
        function initializePlayer() {
            if (!currentLesson) return;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('lessonTitle').textContent = currentLesson.title;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–æ–≤–∞
            words = currentLesson.words || [];
            renderTranscript();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Vimeo –ø–ª–µ–µ—Ä
            if (currentLesson.vimeo_id) {
                console.log('Initializing Vimeo player with ID:', currentLesson.vimeo_id);
                initializeVimeoPlayer(currentLesson.vimeo_id);
            } else {
                showError('Vimeo ID –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞');
            }
        }
        
        function initializeVimeoPlayer(vimeoId) {
            const iframe = document.getElementById('vimeoPlayer');
            const placeholder = document.getElementById('videoPlaceholder');
            const statusIndicator = document.getElementById('statusIndicator');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å Vimeo ID
            if (!vimeoId || isNaN(parseInt(vimeoId))) {
                showError('–ù–µ–≤–µ—Ä–Ω—ã–π Vimeo ID: ' + vimeoId);
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è Vimeo —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const vimeoUrl = `https://player.vimeo.com/video/${vimeoId}?autoplay=0&controls=1&responsive=1&title=0&byline=0&portrait=0`;
            console.log('Vimeo URL:', vimeoUrl);
            
            iframe.src = vimeoUrl;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–µ–µ—Ä
            try {
                vimeoPlayer = new Vimeo.Player(iframe);
                console.log('Vimeo Player instance created');
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Vimeo
                vimeoPlayer.ready().then(() => {
                    console.log('Vimeo player ready');
                    isPlayerReady = true;
                    statusIndicator.textContent = '–ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤';
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º placeholder –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º iframe
                    setTimeout(() => {
                        placeholder.style.display = 'none';
                        iframe.style.display = 'block';
                        enableControls();
                        showToast('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
                    }, 500);
                    
                }).catch(error => {
                    console.error('Vimeo ready error:', error);
                    statusIndicator.textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏';
                    showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Vimeo –ø–ª–µ–µ—Ä–∞: ' + error.message);
                });
                
                vimeoPlayer.on('play', function() {
                    console.log('Video playing');
                    isVideoLoaded = true;
                    startTracking();
                    showToast('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
                });
                
                vimeoPlayer.on('pause', function() {
                    console.log('Video paused');
                    stopTracking();
                    showToast('‚è∏Ô∏è –ü–∞—É–∑–∞');
                });
                
                vimeoPlayer.on('timeupdate', function(data) {
                    highlightCurrentWord(data.seconds);
                });
                
                vimeoPlayer.on('loaded', function() {
                    console.log('Video loaded');
                    isVideoLoaded = true;
                    statusIndicator.textContent = '–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                });
                
                vimeoPlayer.on('error', function(error) {
                    console.error('Vimeo player error:', error);
                    let errorMsg = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ';
                    
                    if (error.name === 'PasswordError') {
                        errorMsg = '–í–∏–¥–µ–æ –∑–∞—â–∏—â–µ–Ω–æ –ø–∞—Ä–æ–ª–µ–º';
                    } else if (error.name === 'PrivacyError') {
                        errorMsg = '–í–∏–¥–µ–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg = '–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Vimeo ID';
                    }
                    
                    statusIndicator.textContent = errorMsg;
                    showError(errorMsg);
                });
                
                // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ iframe
                iframe.addEventListener('load', function() {
                    console.log('Iframe loaded');
                    statusIndicator.textContent = 'Iframe –∑–∞–≥—Ä—É–∂–µ–Ω';
                });
                
            } catch (error) {
                console.error('Error creating Vimeo player:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Vimeo –ø–ª–µ–µ—Ä–∞: ' + error.message);
            }
        }
        
        function enableControls() {
            const buttons = document.querySelectorAll('.controls button');
            buttons.forEach(btn => {
                btn.disabled = false;
            });
        }
        
        function disableControls() {
            const buttons = document.querySelectorAll('.controls button');
            buttons.forEach(btn => {
                btn.disabled = true;
            });
        }
        
        function startTracking() {
            if (trackingInterval) clearInterval(trackingInterval);
            
            trackingInterval = setInterval(async () => {
                if (vimeoPlayer && isPlayerReady && isVideoLoaded) {
                    try {
                        const currentTime = await vimeoPlayer.getCurrentTime();
                        highlightCurrentWord(currentTime);
                    } catch (error) {
                        console.error('Error getting time:', error);
                    }
                }
            }, 100);
        }
        
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
        }
        
        function renderTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            transcriptDiv.innerHTML = '';
            
            if (words.length === 0) {
                transcriptDiv.innerHTML = '<div class="loading">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω</div>';
                return;
            }
            
            words.forEach((word, index) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'word';
                wordSpan.textContent = word.text + ' ';
                wordSpan.dataset.index = index;
                wordSpan.dataset.start = word.start;
                transcriptDiv.appendChild(wordSpan);
            });
            
            addWordClickHandlers();
        }
        
        function addWordClickHandlers() {
            document.querySelectorAll('.word').forEach(wordSpan => {
                wordSpan.addEventListener('click', function() {
                    const startTime = parseFloat(this.dataset.start);
                    playFromTime(startTime);
                });
            });
        }
        
        async function playFromTime(startTime) {
            if (vimeoPlayer && isPlayerReady && isVideoLoaded) {
                try {
                    await vimeoPlayer.setCurrentTime(startTime);
                    await vimeoPlayer.play();
                    showToast('üé¨ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ—Ä–∞–∑–µ...');
                } catch (error) {
                    console.error('Error seeking:', error);
                    showToast('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–æ—Ç–∫–∏');
                }
            } else {
                showToast('‚è≥ –ü–ª–µ–µ—Ä –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
            }
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–æ–º - –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò
        async function playPause() {
            if (!isPlayerReady || !isVideoLoaded) {
                showToast('‚è≥ –í–∏–¥–µ–æ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
                return;
            }
            
            if (vimeoPlayer) {
                try {
                    const paused = await vimeoPlayer.getPaused();
                    if (paused) {
                        await vimeoPlayer.play();
                        showToast('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
                    } else {
                        await vimeoPlayer.pause();
                        showToast('‚è∏Ô∏è –ü–∞—É–∑–∞');
                    }
                } catch (error) {
                    console.error('Error play/pause:', error);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã
                    showToast('‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ø–ª–µ–µ—Ä–µ');
                }
            }
        }
        
        async function restart() {
            if (!isPlayerReady || !isVideoLoaded) {
                showToast('‚è≥ –í–∏–¥–µ–æ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
                return;
            }
            
            if (vimeoPlayer) {
                try {
                    await vimeoPlayer.setCurrentTime(0);
                    await vimeoPlayer.play();
                    showToast('üîÑ –ù–∞—á–∞–ª–æ —É—Ä–æ–∫–∞');
                } catch (error) {
                    console.error('Error restart:', error);
                    showToast('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞');
                }
            }
        }
        
        async function skipBack() {
            if (!isPlayerReady || !isVideoLoaded) {
                showToast('‚è≥ –í–∏–¥–µ–æ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
                return;
            }
            
            if (vimeoPlayer) {
                try {
                    const currentTime = await vimeoPlayer.getCurrentTime();
                    await vimeoPlayer.setCurrentTime(Math.max(0, currentTime - 5));
                    showToast('‚è™ –ù–∞ 5—Å –Ω–∞–∑–∞–¥');
                } catch (error) {
                    console.error('Error skip back:', error);
                }
            }
        }
        
        async function skipForward() {
            if (!isPlayerReady || !isVideoLoaded) {
                showToast('‚è≥ –í–∏–¥–µ–æ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
                return;
            }
            
            if (vimeoPlayer) {
                try {
                    const currentTime = await vimeoPlayer.getCurrentTime();
                    const duration = await vimeoPlayer.getDuration();
                    await vimeoPlayer.setCurrentTime(Math.min(duration, currentTime + 5));
                    showToast('‚è© –ù–∞ 5—Å –≤–ø–µ—Ä–µ–¥');
                } catch (error) {
                    console.error('Error skip forward:', error);
                }
            }
        }
        
        async function toggleMute() {
            if (!isPlayerReady || !isVideoLoaded) {
                showToast('‚è≥ –í–∏–¥–µ–æ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
                return;
            }
            
            if (vimeoPlayer) {
                try {
                    const muted = await vimeoPlayer.getMuted();
                    await vimeoPlayer.setMuted(!muted);
                    showToast(!muted ? 'üîá –ë–µ–∑ –∑–≤—É–∫–∞' : 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω');
                } catch (error) {
                    console.error('Error toggle mute:', error);
                }
            }
        }
        
        async function changeSpeed(rate) {
            if (!isPlayerReady || !isVideoLoaded) {
                showToast('‚è≥ –í–∏–¥–µ–æ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
                return;
            }
            
            if (vimeoPlayer) {
                try {
                    await vimeoPlayer.setPlaybackRate(rate);
                    showToast(`üéöÔ∏è –°–∫–æ—Ä–æ—Å—Ç—å: ${rate}x`);
                } catch (error) {
                    console.error('Error change speed:', error);
                }
            }
        }
        
        function highlightCurrentWord(currentTime) {
            document.querySelectorAll('.word').forEach(word => {
                word.classList.remove('active');
            });
            
            const currentWordIndex = words.findIndex(word => 
                currentTime >= word.start && currentTime < word.end
            );
            
            if (currentWordIndex !== -1) {
                const currentWordElement = document.querySelector(`.word[data-index="${currentWordIndex}"]`);
                if (currentWordElement) {
                    currentWordElement.classList.add('active');
                    scrollToElementInContainer(currentWordElement);
                }
            }
        }
        
        function scrollToElementInContainer(element) {
            const container = document.getElementById('transcriptContainer');
            const elementRect = element.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const isVisible = (
                elementRect.top >= containerRect.top &&
                elementRect.bottom <= containerRect.bottom
            );
            
            if (!isVisible) {
                const elementOffset = element.offsetTop;
                const containerHeight = container.clientHeight;
                const elementHeight = element.clientHeight;
                
                const targetScroll = elementOffset - (containerHeight / 2) + (elementHeight / 2);
                
                container.scrollTo({
                    top: targetScroll,
                    behavior: 'smooth'
                });
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            errorContainer.style.display = 'block';
            
            document.getElementById('lessonTitle').textContent = '–û—à–∏–±–∫–∞';
            disableControls();
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.onClick(() => {
            if (trackingInterval) clearInterval(trackingInterval);
            tg.close();
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadLessonData();
    </script>
</body>
</html>
