<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ –£—Ä–æ–∫ - –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –±—É–∫–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
        }
        
        .transcript-container {
            margin-top: 25px;
            max-height: 60vh;
            overflow-y: auto;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
        }
        
        .transcript {
            line-height: 2.2;
            font-size: 24px;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        }
        
        .letter {
            display: inline-block;
            min-width: 16px;
            text-align: center;
            transition: all 0.15s ease;
            padding: 2px 1px;
            margin: 0 1px;
            border-radius: 4px;
            position: relative;
        }
        
        .letter.active {
            background: linear-gradient(135deg, var(--tg-theme-button-color, #40a7e3), #2d93d0);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-weight: 700;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(64, 167, 227, 0.3);
        }
        
        .letter.space {
            min-width: 8px;
        }
        
        .letter.space.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: var(--tg-theme-button-color, #40a7e3);
            border-radius: 2px;
        }
        
        .word-boundary {
            margin-right: 12px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            cursor: pointer;
            flex: 1;
            min-width: 140px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .lesson-title {
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .progress-indicator {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="lesson-title" id="lessonTitle">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞...</div>
    
    <audio id="audioPlayer" class="audio-player" controls>
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã.
    </audio>
    
    <div class="controls">
        <button onclick="playPause()">‚èØÔ∏è –ü–∞—É–∑–∞/–°—Ç–∞—Ä—Ç</button>
        <button onclick="restart()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
        <button onclick="slowDown()">üê¢ –ó–∞–º–µ–¥–ª–∏—Ç—å</button>
        <button onclick="normalSpeed()">‚ö° –ù–æ—Ä–º–∞–ª—å–Ω–æ</button>
    </div>
    
    <div class="transcript-container">
        <div id="transcript" class="transcript"></div>
    </div>
    
    <div class="progress-indicator" id="progressIndicator">–ì–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        
        let currentLesson = null;
        let letters = [];
        
        function loadLessonData() {
            // –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∞–µ–º –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
            const exampleData = {
                "audio_url": "https://example.com/audio/lesson1.mp3",
                "title": "–£—Ä–æ–∫ 1 - –ë—É–∫–≤–µ–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞",
                "letters": [
                    {"start": 0.0, "end": 0.3, "text": "H", "isSpace": false},
                    {"start": 0.3, "end": 0.6, "text": "e", "isSpace": false},
                    {"start": 0.6, "end": 0.9, "text": "l", "isSpace": false},
                    {"start": 0.9, "end": 1.2, "text": "l", "isSpace": false},
                    {"start": 1.2, "end": 1.5, "text": "o", "isSpace": false},
                    {"start": 1.5, "end": 1.6, "text": " ", "isSpace": true},
                    {"start": 1.6, "end": 1.9, "text": "w", "isSpace": false},
                    {"start": 1.9, "end": 2.2, "text": "o", "isSpace": false},
                    {"start": 2.2, "end": 2.5, "text": "r", "isSpace": false},
                    {"start": 2.5, "end": 2.8, "text": "l", "isSpace": false},
                    {"start": 2.8, "end": 3.1, "text": "d", "isSpace": false},
                    {"start": 3.1, "end": 3.4, "text": "!", "isSpace": false}
                ]
            };
            
            currentLesson = exampleData;
            initializePlayer();
        }
        
        function initializePlayer() {
            if (!currentLesson) return;
            
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = currentLesson.audio_url;
            letters = currentLesson.letters || [];
            
            document.getElementById('lessonTitle').textContent = currentLesson.title;
            renderTranscript();
            
            audioPlayer.addEventListener('timeupdate', highlightCurrentLetter);
            audioPlayer.addEventListener('play', updateProgressIndicator);
            audioPlayer.addEventListener('pause', updateProgressIndicator);
        }
        
        function renderTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            transcriptDiv.innerHTML = '';
            
            let currentWord = [];
            
            letters.forEach((letter, index) => {
                const letterSpan = document.createElement('span');
                letterSpan.className = `letter ${letter.isSpace ? 'space' : ''}`;
                letterSpan.textContent = letter.text;
                letterSpan.dataset.index = index;
                letterSpan.dataset.start = letter.start;
                
                transcriptDiv.appendChild(letterSpan);
            });
        }
        
        function highlightCurrentLetter() {
            const currentTime = document.getElementById('audioPlayer').currentTime;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            document.querySelectorAll('.letter').forEach(letter => {
                letter.classList.remove('active');
            });
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –±—É–∫–≤—É
            const currentLetterIndex = letters.findIndex(letter => 
                currentTime >= letter.start && currentTime < letter.end
            );
            
            if (currentLetterIndex !== -1) {
                const currentLetter = document.querySelector(`.letter[data-index="${currentLetterIndex}"]`);
                if (currentLetter) {
                    currentLetter.classList.add('active');
                    
                    // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∞–∫—Ç–∏–≤–Ω–æ–π –±—É–∫–≤–µ
                    currentLetter.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'center'
                    });
                }
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã
                for (let i = 0; i < currentLetterIndex; i++) {
                    const passedLetter = document.querySelector(`.letter[data-index="${i}"]`);
                    if (passedLetter && !passedLetter.classList.contains('active')) {
                        passedLetter.style.opacity = '0.7';
                    }
                }
            }
            
            updateProgressIndicator();
        }
        
        function updateProgressIndicator() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progress = document.getElementById('progressIndicator');
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration || 1;
            
            const percent = (currentTime / duration) * 100;
            const currentWord = getCurrentWord(currentTime);
            
            progress.textContent = `${Math.round(percent)}% ‚Ä¢ ${formatTime(currentTime)} / ${formatTime(duration)} ${currentWord ? `‚Ä¢ "${currentWord}"` : ''}`;
        }
        
        function getCurrentWord(currentTime) {
            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–æ–≤–æ, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
            let word = '';
            let inWord = false;
            
            for (const letter of letters) {
                if (!letter.isSpace && currentTime >= letter.start && currentTime < letter.end) {
                    word += letter.text;
                    inWord = true;
                } else if (inWord && letter.isSpace) {
                    break;
                }
            }
            
            return word || null;
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function playPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        }
        
        function restart() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        }
        
        function slowDown() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.playbackRate = 0.75;
        }
        
        function normalSpeed() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.playbackRate = 1.0;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
        tg.BackButton.onClick(() => {
            tg.close();
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadLessonData();
    </script>
</body>
</html>
